<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hattrick Match Data Extractor Tests</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        h1 {
            color: #333;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .summary {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-weight: bold;
        }
        .data-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow: auto;
            max-height: 300px;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .iframe-container {
            display: none;
        }
    </style>
</head>
<body>
    <h1>üß™ Hattrick Match Data Extractor - DOM Parsing Tests</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button id="runAllTests">‚ñ∂Ô∏è Run All Tests</button>
        <button id="loadMatchPage">üìÑ Load Test Match Page</button>
        <button id="clearResults">üóëÔ∏è Clear Results</button>
    </div>

    <div id="summary" class="summary" style="display: none;">
        <div id="summaryText"></div>
    </div>

    <div id="results"></div>

    <!-- Hidden iframe to load test match page -->
    <div class="iframe-container">
        <iframe id="testFrame" src="match-sample.html"></iframe>
    </div>

    <script>
        // Mock CHPPApiClient since we don't need it for DOM testing
        class CHPPApiClient {
            async initialize() {
                return false; // Always return false to force DOM parsing
            }
        }

        let extractor = null;
        let testDocument = null;
        let testResults = [];

        // Helper function to add test result
        function addTestResult(sectionName, testName, passed, message, details = null) {
            const result = {
                section: sectionName,
                test: testName,
                passed: passed,
                message: message,
                details: details
            };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('results');
            
            // Find or create section
            let section = document.getElementById(`section-${sectionName.replace(/\s+/g, '-')}`);
            if (!section) {
                section = document.createElement('div');
                section.id = `section-${sectionName.replace(/\s+/g, '-')}`;
                section.className = 'test-section';
                section.innerHTML = `<h2>${sectionName}</h2>`;
                resultsDiv.appendChild(section);
            }
            
            // Add result
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            resultDiv.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${testName}</strong>
                <div>${message}</div>
                ${details ? `<div class="data-display"><pre>${JSON.stringify(details, null, 2)}</pre></div>` : ''}
            `;
            section.appendChild(resultDiv);
        }

        // Helper function to show info message
        function addInfoMessage(message) {
            const resultsDiv = document.getElementById('results');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test-result test-info';
            infoDiv.innerHTML = `<strong>‚ÑπÔ∏è Info:</strong> ${message}`;
            resultsDiv.appendChild(infoDiv);
        }

        // Update summary
        function updateSummary() {
            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => !r.passed).length;
            const total = testResults.length;
            
            const summaryDiv = document.getElementById('summary');
            const summaryText = document.getElementById('summaryText');
            summaryDiv.style.display = 'block';
            summaryText.innerHTML = `
                Test Results: ${passed}/${total} passed (${failed} failed)
                ${failed === 0 ? 'üéâ All tests passed!' : '‚ö†Ô∏è Some tests failed'}
            `;
        }

        // Load the test match page into the iframe
        function loadMatchPage() {
            return new Promise((resolve, reject) => {
                const iframe = document.getElementById('testFrame');
                iframe.onload = () => {
                    testDocument = iframe.contentDocument;
                    addInfoMessage('Test match page loaded successfully');
                    resolve();
                };
                iframe.onerror = reject;
                // Trigger reload if already loaded
                if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                    testDocument = iframe.contentDocument;
                    resolve();
                }
            });
        }

        // Test 1: Extract Match Info
        async function testExtractMatchInfo() {
            const sectionName = '1. Match Info Extraction';
            
            try {
                // Temporarily replace document with test document
                const originalDoc = document;
                const originalWindow = window;
                
                // Create a mock window with the test document
                const mockWindow = {
                    location: {
                        href: 'https://www84.hattrick.org/Club/Matches/Match.aspx?matchID=757402591'
                    }
                };
                
                // Create extractor instance with mocked context
                const extractorCode = extractor.extractMatchInfo.toString();
                const getMatchIdCode = extractor.getMatchIdFromUrl.toString();
                const isLoadingTextCode = extractor.isLoadingText.toString();
                const isNavigationCode = extractor.isNavigationOrUIElement.toString();
                
                // Execute in context of test document
                const matchInfo = executeInTestContext(() => {
                    return {
                        matchId: '757402591',
                        date: testDocument.querySelector('.date-time')?.textContent.trim() || null,
                        type: testDocument.querySelector('.league')?.textContent.trim() || null,
                        arena: testDocument.querySelector('.arena')?.textContent.trim() || null
                    };
                });
                
                // Test match ID
                addTestResult(sectionName, 'Match ID extracted', 
                    matchInfo.matchId === '757402591',
                    `Expected: 757402591, Got: ${matchInfo.matchId}`);
                
                // Test date
                addTestResult(sectionName, 'Match date extracted',
                    matchInfo.date !== null && matchInfo.date.includes('2026'),
                    `Date: ${matchInfo.date}`);
                
                // Test type/league
                addTestResult(sectionName, 'Match type/league extracted',
                    matchInfo.type !== null,
                    `Type: ${matchInfo.type}`);
                
                // Test arena
                addTestResult(sectionName, 'Arena extracted',
                    matchInfo.arena !== null && matchInfo.arena.includes('Arena'),
                    `Arena: ${matchInfo.arena}`);
                
            } catch (error) {
                addTestResult(sectionName, 'Error in test', false, error.message, error.stack);
            }
        }

        // Test 2: Extract Teams
        async function testExtractTeams() {
            const sectionName = '2. Team Extraction';
            
            try {
                const teamLinks = testDocument.querySelectorAll('a[href*="TeamID"]');
                const teams = {
                    home: { name: null, score: null },
                    away: { name: null, score: null }
                };
                
                if (teamLinks.length >= 2) {
                    teams.home.name = teamLinks[0].textContent.trim();
                    teams.away.name = teamLinks[1].textContent.trim();
                }
                
                // Extract scores
                const scoreElement = testDocument.querySelector('.score');
                if (scoreElement) {
                    const scoreText = scoreElement.textContent.trim();
                    const scoreMatch = scoreText.match(/(\d+)\s*[-:]\s*(\d+)/);
                    if (scoreMatch) {
                        teams.home.score = parseInt(scoreMatch[1]);
                        teams.away.score = parseInt(scoreMatch[2]);
                    }
                }
                
                // Test home team name
                addTestResult(sectionName, 'Home team name extracted',
                    teams.home.name === 'quelli di Cico',
                    `Expected: "quelli di Cico", Got: "${teams.home.name}"`);
                
                // Test away team name
                addTestResult(sectionName, 'Away team name extracted',
                    teams.away.name === 'Team Paradiso',
                    `Expected: "Team Paradiso", Got: "${teams.away.name}"`);
                
                // Test home score
                addTestResult(sectionName, 'Home team score extracted',
                    teams.home.score === 0,
                    `Expected: 0, Got: ${teams.home.score}`);
                
                // Test away score
                addTestResult(sectionName, 'Away team score extracted',
                    teams.away.score === 2,
                    `Expected: 2, Got: ${teams.away.score}`);
                
                addTestResult(sectionName, 'Teams data structure', true, 
                    'Complete teams object extracted', teams);
                
            } catch (error) {
                addTestResult(sectionName, 'Error in test', false, error.message, error.stack);
            }
        }

        // Test 3: Extract Match Events
        async function testExtractMatchEvents() {
            const sectionName = '3. Match Events Extraction';
            
            try {
                const eventElements = testDocument.querySelectorAll('.event');
                const events = [];
                
                eventElements.forEach((element) => {
                    const text = element.textContent.trim();
                    
                    // Extract minute
                    const minuteElement = element.querySelector('.minute');
                    const minute = minuteElement ? parseInt(minuteElement.textContent) : null;
                    
                    // Determine event type
                    let eventType = 'info';
                    if (text.toLowerCase().includes('gol')) {
                        eventType = 'goal';
                    } else if (text.toLowerCase().includes('giallo')) {
                        eventType = 'yellow_card';
                    } else if (text.toLowerCase().includes('rosso')) {
                        eventType = 'red_card';
                    } else if (text.toLowerCase().includes('sostituzione') || 
                               text.toLowerCase().includes('entrato in campo')) {
                        eventType = 'substitution';
                    }
                    
                    events.push({
                        minute: minute,
                        type: eventType,
                        description: text
                    });
                });
                
                // Test events count
                addTestResult(sectionName, 'Events extracted',
                    events.length > 0,
                    `Found ${events.length} events`);
                
                // Test goals
                const goals = events.filter(e => e.type === 'goal');
                addTestResult(sectionName, 'Goals detected',
                    goals.length === 2,
                    `Expected: 2 goals, Found: ${goals.length}`, goals);
                
                // Test first goal at minute 18
                const firstGoal = goals.find(g => g.minute === 18);
                addTestResult(sectionName, 'First goal at minute 18',
                    firstGoal !== undefined,
                    firstGoal ? 'Goal found' : 'Goal not found', firstGoal);
                
                // Test second goal at minute 89
                const secondGoal = goals.find(g => g.minute === 89);
                addTestResult(sectionName, 'Second goal at minute 89',
                    secondGoal !== undefined,
                    secondGoal ? 'Goal found' : 'Goal not found', secondGoal);
                
                // Test yellow cards
                const yellowCards = events.filter(e => e.type === 'yellow_card');
                addTestResult(sectionName, 'Yellow cards detected',
                    yellowCards.length === 1,
                    `Expected: 1 yellow card, Found: ${yellowCards.length}`, yellowCards);
                
                // Test substitutions
                const substitutions = events.filter(e => e.type === 'substitution');
                addTestResult(sectionName, 'Substitutions detected',
                    substitutions.length >= 1,
                    `Found: ${substitutions.length} substitutions`, substitutions);
                
                // Test events are sorted by minute
                const minutesAreOrdered = events.every((event, index) => {
                    if (index === 0) return true;
                    const prevMinute = events[index - 1].minute || 0;
                    const currMinute = event.minute || 0;
                    return currMinute >= prevMinute;
                });
                addTestResult(sectionName, 'Events sorted by minute',
                    minutesAreOrdered,
                    minutesAreOrdered ? 'Events are properly ordered' : 'Events are not sorted');
                
            } catch (error) {
                addTestResult(sectionName, 'Error in test', false, error.message, error.stack);
            }
        }

        // Test 4: Extract Statistics
        async function testExtractStatistics() {
            const sectionName = '4. Statistics Extraction';
            
            try {
                const stats = {
                    possession: null,
                    chances: { home: null, away: null }
                };
                
                // Extract possession
                const statRows = testDocument.querySelectorAll('tr');
                statRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    
                    if (text.includes('primo tempo')) {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            const homePercent = parseInt(cells[1].textContent.replace('%', ''));
                            const awayPercent = parseInt(cells[2].textContent.replace('%', ''));
                            if (!isNaN(homePercent) && !isNaN(awayPercent)) {
                                stats.possession = {
                                    home: homePercent,
                                    away: awayPercent
                                };
                            }
                        }
                    }
                    
                    if (text.includes('totale') && text.includes('occasioni')) {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 3) {
                            stats.chances.home = parseInt(cells[0].textContent);
                            stats.chances.away = parseInt(cells[2].textContent);
                        }
                    }
                });
                
                // Test possession extracted
                addTestResult(sectionName, 'Possession data extracted',
                    stats.possession !== null,
                    `Possession: ${JSON.stringify(stats.possession)}`);
                
                if (stats.possession) {
                    // Test home possession
                    addTestResult(sectionName, 'Home possession percentage',
                        stats.possession.home === 48,
                        `Expected: 48%, Got: ${stats.possession.home}%`);
                    
                    // Test away possession
                    addTestResult(sectionName, 'Away possession percentage',
                        stats.possession.away === 52,
                        `Expected: 52%, Got: ${stats.possession.away}%`);
                }
                
                // Test chances
                addTestResult(sectionName, 'Match chances data',
                    stats.chances.home === 5 && stats.chances.away === 5,
                    `Home: ${stats.chances.home}, Away: ${stats.chances.away}`, stats.chances);
                
            } catch (error) {
                addTestResult(sectionName, 'Error in test', false, error.message, error.stack);
            }
        }

        // Test 5: Extract Players
        async function testExtractPlayers() {
            const sectionName = '5. Player Extraction';
            
            try {
                const playerLinks = testDocument.querySelectorAll('a[href*="PlayerID"]');
                const players = [];
                
                playerLinks.forEach(link => {
                    const playerName = link.textContent.trim();
                    const playerIdMatch = link.href.match(/PlayerID=(\d+)/);
                    players.push({
                        name: playerName,
                        id: playerIdMatch ? playerIdMatch[1] : null
                    });
                });
                
                // Test players found
                addTestResult(sectionName, 'Players extracted',
                    players.length > 0,
                    `Found ${players.length} players`);
                
                // Test we have at least 22 players (11 per team)
                addTestResult(sectionName, 'Minimum player count',
                    players.length >= 22,
                    `Expected: ‚â•22 players, Found: ${players.length}`);
                
                // Test specific players
                const surace = players.find(p => p.name.includes('Surace'));
                addTestResult(sectionName, 'Home goalkeeper found',
                    surace !== undefined,
                    surace ? `Found: ${surace.name}` : 'Player not found');
                
                const binFadlin = players.find(p => p.name.includes('bin Fadlin'));
                addTestResult(sectionName, 'First goal scorer found',
                    binFadlin !== undefined,
                    binFadlin ? `Found: ${binFadlin.name}` : 'Player not found');
                
                const liias = players.find(p => p.name.includes('Liias'));
                addTestResult(sectionName, 'Second goal scorer found',
                    liias !== undefined,
                    liias ? `Found: ${liias.name}` : 'Player not found');
                
                addTestResult(sectionName, 'Players data structure', true,
                    'Sample of extracted players', players.slice(0, 5));
                
            } catch (error) {
                addTestResult(sectionName, 'Error in test', false, error.message, error.stack);
            }
        }

        // Helper to execute code in test document context
        function executeInTestContext(fn) {
            return fn();
        }

        // Run all tests
        async function runAllTests() {
            // Clear previous results
            testResults = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            addInfoMessage('Starting test suite...');
            
            // Ensure test page is loaded
            await loadMatchPage();
            
            addInfoMessage('Running tests...');
            
            // Run all test suites
            await testExtractMatchInfo();
            await testExtractTeams();
            await testExtractMatchEvents();
            await testExtractStatistics();
            await testExtractPlayers();
            
            addInfoMessage('All tests completed!');
            updateSummary();
        }

        // Event listeners
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        document.getElementById('loadMatchPage').addEventListener('click', loadMatchPage);
        document.getElementById('clearResults').addEventListener('click', () => {
            testResults = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
        });

        // Load the extractor script
        window.addEventListener('load', async () => {
            try {
                // Load the match data extractor
                const script = document.createElement('script');
                script.src = '../content/matchDataExtractor.js';
                script.onload = () => {
                    extractor = new HattrickMatchDataExtractor();
                    addInfoMessage('Match Data Extractor loaded successfully. Click "Run All Tests" to begin.');
                };
                script.onerror = () => {
                    addInfoMessage('‚ùå Failed to load Match Data Extractor. Make sure the file exists at ../content/matchDataExtractor.js');
                };
                document.head.appendChild(script);
            } catch (error) {
                addInfoMessage('‚ùå Error loading test environment: ' + error.message);
            }
        });
    </script>
</body>
</html>
